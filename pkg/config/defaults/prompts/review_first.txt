# first review prompt
# this prompt is used for the first (comprehensive) review pass in phase 2
# launches 5 parallel agents for thorough code review
#
# available variables:
#   {{PLAN_FILE}} - path to the plan file being executed
#   {{GOAL}} - human-readable goal description
#   {{agent:name}} - expands to Task tool instructions for the named agent
#
# agents are defined in ~/.config/ralphex/agents/ (user) or pkg/config/defaults/agents/ (builtin)

Code review of: {{GOAL}}

## Step 1: Get Branch Diff

Run: `git diff master...HEAD`

## Step 2: Launch ALL 5 Review Agents IN PARALLEL

Use the Task tool to launch all 5 agents in parallel (multiple Task calls in one response).

Agents to launch:
{{agent:quality}}
{{agent:implementation}}
{{agent:testing}}
{{agent:simplification}}
{{agent:documentation}}

Each agent prompt should include the diff and instruct: "Report problems only - no positive observations."

## Step 3: Collect, Verify, and Fix Findings

After agents complete:

### 3.1 Collect and Deduplicate
- Merge findings from all agents
- Same file:line + same issue → merge
- Cross-agent duplicates → merge, note both sources

### 3.2 Verify EVERY Finding (CRITICAL)
For EACH issue (bugs, test gaps, smells, over-engineering, error handling, docs, etc.):
1. Read actual code at file:line
2. Check full context (20-30 lines around)
3. Verify issue is real, not a false positive
4. Check for existing mitigations

Classify as:
- CONFIRMED: Real issue, fix it
- FALSE POSITIVE: Doesn't exist or already mitigated - discard

IMPORTANT: Pre-existing issues (linter errors, failed tests) should also be fixed.
Do NOT reject issues just because they existed before this branch - fix them anyway.

### 3.3 Fix All Confirmed Issues
1. Fix all CONFIRMED issues (all types: bugs, tests, smells, docs, etc.)
2. Run tests and linter to verify fixes - ALL tests must pass, ALL linter issues resolved
3. Commit fixes: `git commit -m "fix: address code review findings"`

## Step 4: Signal Completion

After fixing all confirmed issues (or if none found), output exactly: <<<RALPHEX:REVIEW_DONE>>>

Then STOP. Do not continue. The external loop will run additional review passes to verify.

If unable to fix issues after reasonable attempts: <<<RALPHEX:TASK_FAILED>>>

OUTPUT FORMAT: No markdown formatting (no **bold**, `code`, # headers). Plain text and - lists are fine.
